<!DOCTYPE html>
<html>
<!-- Import necessary libraries from Google APIs, PyScript website -->
<head>
  <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=yes, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>

<!-- Style adjustments -->
<style> 
    body {
    	font-family: 'Montserrat';
    	font-size: 20px;
    	text-align: center;
    	font-weight: bold;
        color: black;
  	}
    
    .container {
      text-align: center;
    }
    .btn {
    	display: inline-block;
    	font-size: 22px;
      padding: 0.5em 1em;
      border: none;
      text-align: center;
      background: white;
      left: 50%;
    }
    
    .btn:hover {
      color: white;
      transition: .5s ease-out;
    }

    .pca:hover {
      background: #18de50;
    }
    
    .tsne:hover {
      background: #223dd4;
    }
    .choose:hover {
      background: white;
      color: black;
    }
    
</style>
<body>
  
<!-- loading screen -->
<dialog id="loading">
  <h1>Loading...</h1>
</dialog>

<!-- Only accept HDF5 file types -->
<label for="myH5File">
  Upload an H5 file here!
</label>
<input type="file" class="btn choose" accept=".h5, .hdf5" id="myH5File">
<br><br>

<!-- allow the user to choose between PCA and t-SNE -->
<div class="container">
  <h3> Please choose a dimensionality reduction method: </h3>
  <button id="pca button" class="btn pca">PCA</button>
  <button id="tsne button" class="btn tsne">T-SNE</button>
</div>


<!--import packages -->
<py-config style="color: transparent; user-select: none;">
  packages = ["pandas", "scikit-learn", "matplotlib", "anndata", "disable_warnings"]
</py-config>

<!-- enable download -->
<script>
  function createLink(dataURL, id) {
    a = document.getElementById(id);
    a.href = dataURL;
  }
</script>
<!-- main Python code -->
<py-script>

# import necessary libraries
import pandas as pd
import js
import io
import base64
import pyodide
import matplotlib.pyplot as plt
from sklearn.cluster import KMeans
from sklearn.manifold import TSNE
from sklearn.preprocessing import StandardScaler
from sklearn.decomposition import PCA
import anndata as ad
from disable_warnings import *

# Upon uploading a file, we want to generate an interactive graph
# Base64 encoder to enable embedding the image itself into the div
def fig_to_base64(fig):
  img = io.BytesIO()
  fig.savefig(img, format='png', bbox_inches='tight')
  img.seek(0)
  return base64.b64encode(img.getvalue())

# Process the .h5 uploaded once the file selected changes from 'No file selected'
async def processFile(e):
  files = e.target.files.to_py()
  for file in files:
    data = js.Uint8Array.new(await file.arrayBuffer())
    df = ad.read_h5ad(io.BytesIO(bytearray(data))).to_df().round(4)
    
    # PCA Graph
    X = StandardScaler().fit_transform(df)
    pca = PCA(n_components = 2).fit_transform(X)
    pca_df = pd.DataFrame(pca, columns = ["PC 1", "PC 2"])
    kmeans = KMeans(n_clusters=4, random_state=0).fit(df)
    predicted_clusters = kmeans.predict(df)
    df['kmean'] = kmeans.labels_
    colors = ['blue', 'yellow', 'green', 'red']
    x = pca_df["PC 1"]
    y = pca_df["PC 2"]
    fig1, ax = plt.subplots()
    for i in range(3):
      idx = predicted_clusters == i
      ax.scatter(x[idx], y[idx], color=colors[i], s=10, alpha=0.25)
    ax.set_title("Single-Cell Behavior (PCA Analysis)")
    ax.set_xlabel("PC 1")
    ax.set_ylabel("PC 2")
    pca_encoded = fig_to_base64(fig1)
    my_html = '<img src="data:image/png;base64,{}">'.format(pca_encoded.decode("utf-8"))
    dataURL = "data:image/png;base64," + pca_encoded.decode("utf-8")
    js.createLink(dataURL, "pca download link")
    js.document.getElementById("pca download link").innerHTML = my_html
    
    # T-SNE Graph
    tsne = TSNE(n_components=3,init="random",random_state=0,n_iter=300)
    tsne = tsne.fit_transform(df)
    tsne_df = pd.DataFrame(tsne, columns = ["t-SNE 1", "t-SNE 2", "t-SNE 3"])
    kmeans = KMeans(n_clusters=3, random_state=0).fit(df)
    y_kmeans = kmeans.predict(df)
    df['kmean'] = kmeans.labels_
    colors = ['red', 'green', 'blue']
    x = tsne_df["t-SNE 1"]
    y = tsne_df["t-SNE 2"]
    z = tsne_df["t-SNE 3"]
    df = df.reset_index().drop("index", axis=1)
    combined_df = pd.concat([tsne_df, df], axis = 1)
    fig2 = plt.Figure()
    ax = fig2.add_subplot(projection="3d")
    for i in range(3):
      idx = y_kmeans == i
      ax.scatter(x[idx], y[idx], z[idx], color=colors[i], s=10, alpha=0.25)
    ax.set_title("Single-Cell Behavior (t-SNE Analysis)")
    ax.set_xlabel("T-SNE 1")
    ax.set_ylabel("T-SNE 2")
    ax.set_zlabel("T-SNE 3")
    tsne_encoded = fig_to_base64(fig2)
    my_html = '<img src="data:image/png;base64,{}">'.format(tsne_encoded.decode("utf-8"))
    dataURL = "data:image/png;base64," + tsne_encoded.decode("utf-8")
    js.createLink(dataURL, "tsne download link")
    js.document.getElementById("tsne download link").innerHTML = my_html

# Hide the t-SNE plot
def PCA_change(self):
    js.document.getElementById("comment").style.display = "inline-block"
    js.document.getElementById("pca matplotlib").style.display = "inline-block"
    js.document.getElementById("tsne matplotlib").style.display = "none"

# Hide the PCA plot
def TSNE_change(self):
    js.document.getElementById("comment").style.display = "inline-block"
    js.document.getElementById("tsne matplotlib").style.display = "inline-block"
    js.document.getElementById("pca matplotlib").style.display = "none"

# Increase user interactivity
process_proxy = pyodide.ffi.create_proxy(processFile)
js.document.getElementById("myH5File").addEventListener("change", process_proxy)
PCA_proxy = pyodide.ffi.create_proxy(PCA_change)
js.document.getElementById("pca button").addEventListener("click", PCA_proxy)
TSNE_proxy = pyodide.ffi.create_proxy(TSNE_change)
js.document.getElementById("tsne button").addEventListener("click", TSNE_proxy)
</py-script>

<!-- PCA plot div, show if PCA selected-->
<div id="pca matplotlib" style="display: none;">
    <a id="pca download link" download="pca plot.png"></a>
</div>

<!-- t-SNE plot div, show if t-SNE selected -->
<div id="tsne matplotlib" style="display: none;">
	<a id="tsne download link" download="tsne plot.png"></a>
</div>
<p id="comment" style="display: none;">To use this viewer, either play around with the interactive plot to see your data come to life, or save the static image generated! To do this, either click on the image, or alternatively, take a screenshot!</p>
</html>
