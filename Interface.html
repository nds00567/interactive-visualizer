<!DOCTYPE html>
<html>
<!-- Import necessary libraries from Google APIs, PyScript website -->
<head>
  <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=yes, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>

<!-- Style adjustments -->
<style> 
    body {
    	font-family: 'Montserrat';
    	font-size: 20px;
    	text-align: center;
    	font-weight: bold;
  	}
    
    .container {
      text-align: center;
    }
    .btn {
    	display: inline-block;
    	font-size: 22px;
      padding: 0.5em 1em;
      border: none;
      text-align: center;
      background: white;
      left: 50%;
    }
    
    .btn:hover {
      color: white;
      transition: .5s ease-out;
    }

    .pca:hover {
      background: #18de50;
    }
    
    .tsne:hover {
      background: #223dd4;
    }
    .choose:hover {
      background: white;
      color: black;
    }
    
</style>
<body>
  
<!-- loading screen -->
<dialog id="loading">
  <h1>Loading...</h1>
</dialog>

<!-- Only accept HDF5 file types -->
<label for="myH5File">
  Upload an H5 file here!
</label>
<input type="file" class="btn choose" accept=".h5, .hdf5" id="myH5File">
<br><br>

<!-- allow the user to choose between PCA and t-SNE -->
<div class="container">
  <h3> Please choose a dimensionality reduction method: </h3>
  <button id="pca button" class="btn pca">PCA</button>
  <button id="tsne button" class="btn tsne">T-SNE</button>
</div>


<!--import packages -->
<py-config style="color: transparent; user-select: none;">
  packages = ["scikit-learn", "matplotlib", "anndata", "disable_warnings"]
</py-config>

<!-- enable download -->
<script>
  function createLink(dataURL) {
    a = document.getElementById("pca download link");
    a.href = dataURL;
  }
</script>
<!-- main Python code -->
<py-script>
  
  # import necessary libraries
  import js
  import io
  import base64
  import pyodide
  import matplotlib.pyplot as plt
  from sklearn.cluster import KMeans
  from sklearn.manifold import TSNE
  from sklearn.preprocessing import StandardScaler
  from sklearn.decomposition import PCA
  import anndata as ad
  from disable_warnings import *
  
  # Upon uploading a file, we want to generate an interactive graph
  
  # Base64 encoder to enable embedding the image itself into the div
  def fig_to_base64(fig):
    img = io.BytesIO()
    fig.savefig(img, format='png',
                bbox_inches='tight')
    img.seek(0)

    return base64.b64encode(img.getvalue())

  # Process the .h5 uploaded once the file selected changes from 'No file selected'
  async def processFile(e):
    files = e.target.files.to_py()
    for file in files:
      data = js.Uint8Array.new(await file.arrayBuffer())
      df = ad.read_h5ad(io.BytesIO(bytearray(data))).to_df().round(4)
      fig, ax = plt.subplots()
      ax.scatter(df["p65 Protein Cytosol"], df["p65 Protein Nucleus"])
      ax.set_title("My Plot")
      ax.set_xlabel("X-axis")
      ax.set_ylabel("Y-axis")
      encoded = fig_to_base64(fig)
      my_html = '<img src="data:image/png;base64,{}">'.format(encoded.decode("utf-8"))
      dataURL = "data:image/png;base64," + encoded.decode("utf-8")
      js.createLink(dataURL)
      js.document.getElementById("pca download link").innerHTML = my_html;
  
  # Hide the t-SNE plot
  def PCA(self):
    print("PCA button works")
  
  # Hide the PCA plot
  def TSNE(self):
    print("t-SNE button works")
  
  # Increase user interactivity
  process_proxy = pyodide.ffi.create_proxy(processFile)
  js.document.getElementById("myH5File").addEventListener("change", process_proxy)
  PCA_proxy = pyodide.ffi.create_proxy(PCA)
  js.document.getElementById("pca button").addEventListener("click", PCA_proxy)
  TSNE_proxy = pyodide.ffi.create_proxy(TSNE)
  js.document.getElementById("tsne button").addEventListener("click", TSNE_proxy)
</py-script>

<!-- PCA plot div, hide if t-SNE selected-->
<div id="pca matplotlib">
  <a id="pca download link" download="plot.png"></a>
</div>

<!-- t-SNE plot div, hide if PCA selected -->
<div id="tsne matplotlib"></div>
</html>
